#!/bin/bash

## Copyright (C) 2025 - 2025 ENCRYPTED SUPPORT LLC <adrelanos@whonix.org>
## See the file COPYING for copying conditions.

set -o errexit
set -o nounset
set -o errtrace
set -o pipefail

true "$0: START"

source /usr/libexec/helper-scripts/lockfile.sh

bl_pct_file='/run/backlight-tool-dist/bl_pct'

## Duplicated in: desktop-config-dist/usr/bin/backlight-tool-dist-agent
read_integer_file() {
  local target_file lower_bound upper_bound file_contents

  target_file="${1:-}"
  lower_bound="${2:-}"
  upper_bound="${3:-}"
  if [ -z "$target_file" ]; then
    printf '%s\n' "$0: ERROR: No target file specified!" >&2
    return 1
  fi
  if [ -n "$lower_bound" ] && ! [[ "$lower_bound" =~ ^[0-9]+$ ]]; then
    printf '%s\n' "$0: ERROR: Non-numeric lower bound specified!" >&2
    return 1
  fi
  if [ -n "$upper_bound" ] && ! [[ "$upper_bound" =~ ^[0-9]+$ ]]; then
    printf '%s\n' "$0: ERROR: Non-numeric upper bound specified!" >&2
    return 1
  fi

  if ! file_contents="$(cat "$target_file")" ; then
    printf '%s\n' "$0: ERROR: Cannot read target file!" >&2
    return 1
  fi
  if [ -z "$file_contents" ]; then
    printf '%s\n' "$0: ERROR: Empty target file!" >&2
    return 1
  fi
  if ! [[ "$file_contents" =~ ^[0-9]+$ ]]; then
    printf '%s\n' "$0: ERROR: Non-numeric value in target file!" >&2
    return 1
  fi
  if [ -n "$lower_bound" ] && (( file_contents < lower_bound )); then
    printf '%s\n' "$0: ERROR: Target file's value '$file_contents' is below the lower bound '$lower_bound'!" >&2
    return 1
  fi
  if [ -n "$upper_bound" ] && (( file_contents > upper_bound )); then
    printf '%s\n' "$0: ERROR: Target file's value '$file_contents' is above the upper bound '$upper_bound'!" >&2
    return 1
  fi

  printf '%s\n' "$file_contents"
}

get_backlight_driver() {
  local bl_driver bl_driver_prio bl_dir cur_bl_driver_type cur_bl_driver_prio;

  bl_driver=""
  bl_driver_prio=""
  for bl_dir in /sys/class/backlight/* ; do
    if [ ! -d "$bl_dir" ]; then
      continue
    fi
    if ! cur_bl_driver_type="$(cat "${bl_dir}/type")" ; then
      continue
    fi
    case "$cur_bl_driver_type" in
    ## LXQt's backlight helper prioritizes backlight drivers with `firmware`
    ## being most preferable, `platform` below `firmware`, `raw` below
    ## `platform`, and everything else below `raw`. Replicate that behavior
    ## here.
    'firmware') cur_bl_driver_prio='4';;
    'platform') cur_bl_driver_prio='3';;
    'raw')      cur_bl_driver_prio='2';;
    *)          cur_bl_driver_prio='1';;
    esac
    if (( cur_bl_driver_prio >= bl_driver_prio )); then
      bl_driver="$bl_dir"
      bl_driver_prio="$cur_bl_driver_prio"
    fi
  done

  if [ -z "$bl_driver" ]; then
    printf '%s\n' "$0: ERROR: No backlight driver found!"
    return 1
  fi
  printf '%s\n' "$bl_driver"
}

backlight_get_val() {
  local bl_pct bl_brightness bl_max_brightness

  if ! bl_brightness="$(read_integer_file "${bl_driver}/actual_brightness")" ; then
    printf '%s\n' "$0: ERROR: Missing or invalid 'actual_brightness' file for backlight driver '$bl_driver'!" >&2
    return 1
  fi
  if ! bl_max_brightness="$(read_integer_file "${bl_driver}/max_brightness")" ; then
    printf '%s\n' "$0: ERROR: Missing or invalid 'max_brightness' file for backlight driver '$bl_driver'!" >&2
    return 1
  fi

  bl_pct=$(( (bl_brightness * 100) / bl_max_brightness )) || true
  if (( bl_pct < 1 )); then
    bl_pct='1'
  elif (( bl_pct > 100 )); then
    bl_pct='100'
  fi
  printf '%s\n' "$bl_pct"
}

backlight_set_val() {
  local bl_pct bl_max_brightness calc_bl_brightness;

  bl_pct="${1:-}"
  if [ -z "$bl_pct" ]; then
    printf '%s\n' "$0: ERROR: No backlight percentage specified!"
    return 1
  fi

  if ! bl_max_brightness="$(read_integer_file "${bl_driver}/max_brightness")" ; then
    printf '%s\n' "$0: ERROR: Missing or invalid 'max_brightness' file for backlight driver '$bl_driver'!" >&2
    return 1
  fi

  calc_bl_brightness=$(( (bl_max_brightness * bl_pct) / 100 )) || true
  if [ "$calc_bl_brightness" = '0' ]; then
    calc_bl_brightness='1'
  fi

  if ! printf '%s\n' "$calc_bl_brightness" > "${bl_driver}/brightness" ; then
    printf '%s\n' "$0: ERROR: Could not write brightness value to '${bl_driver}/brightness'!"
    return 1
  fi
}

backlight_set_val_from_file() {
  local bl_pct

  if ! bl_pct="$(read_integer_file "$bl_pct_file" '1' '100')" ; then
    printf '%s\n' "$0: ERROR: Missing or invalid backlight percentage data!" >&2
    return 1
  fi

  backlight_set_val "$bl_pct" || return 1
}

backlight_mod_val() {
  local mode bl_pct

  mode="${1:-}"
  if [ "$mode" != 'inc' ] && [ "$mode" != 'dec' ]; then
    printf '%s\n' "$0: ERROR: Invalid mode specified for 'backlight_mod_val'!"
    return 1
  fi

  if ! bl_pct="$(backlight_get_val)" ; then
    printf '%s\n' "$0: ERROR: Could not get backlight brightness percentage!"
    return 1
  fi

  if [ "$mode" = 'inc' ]; then
    if (( bl_pct == 1 )); then
      bl_pct='5'
    else
      (( bl_pct += 5 )) || true
    fi
  else
    (( bl_pct -= 5 )) || true
  fi

  if (( bl_pct < 1 )); then
    bl_pct=1
  elif (( bl_pct > 100 )); then
    bl_pct=100
  fi

  backlight_set_val "$bl_pct" || return 1
}

bl_driver="$(get_backlight_driver)" || exit 1

case "${1:-}" in
  'get') backlight_get_val || exit 1;;
  'set') backlight_set_val_from_file || exit 1;;
  'inc') backlight_mod_val 'inc' || exit 1;;
  'dec') backlight_mod_val 'dec' || exit 1;;
  '')
    printf '%s\n' "$0: ERROR: No mode specified!" >&2
    exit 1
    ;;
  *)
    printf '%s\n' "$0: ERROR: Unrecognized mode '$1' specified!" >&2
    exit 1
    ;;
esac

true "$0: END"
